apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: tpa-sequential-deployment
  namespace: openshift-gitops
spec:
  generators:
  - list:
      elements:
        # 1. First Pass: Create the ConfigMap/Secret sources
        - name: vars-and-secrets
          app_wave: 1
          app_path: components/tpa/vars-config.yaml

        # 2. Second Pass: Deploy TPA, relying on the output of App 1
        - name: tpa
          app_path: components/tpa/tpa.yaml
          app_wave: 2
          # CRITICAL: This dependency ensures App 2 only starts when App 1 is Healthy
          dependencies: [vars-and-secrets]

  template:
    metadata:
      # Application name is generated from the list element's 'name'
      name: '{{name}}'
      annotations:
        # Custom annotations from the element list, if any
        argocd.argoproj.io/sync-wave: '{{app_wave}}'

    spec:
      destination:
        server: https://kubernetes.default.svc
        namespace: tssc-tpa
      project: gitops-resources
      source:
        repoURL: https://github.com/smatula/rhtap-services-gitops
        targetRevision: tpa2
        path: '{{app_path}}' # Points to either the 01- or 02- file

      # CRITICAL: This dependency block enforces the sequence
      syncPolicy:
        managedNamespaceMetadata:
          labels:
            argocd.argoproj.io/managed-by: openshift-gitops
        syncOptions:
          # Wait for the dependency app to be Healthy before starting sync
          - RespectDependencies=true
          - CreateNamespace=true
          - PruneLast=true
        automated:
          prune: true
          selfHeal: true

