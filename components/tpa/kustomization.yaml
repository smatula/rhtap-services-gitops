apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
commonAnnotations:
  argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
configMapGenerator:
  - name: tpa-values-source
    namespace: tssc-tpa
    literals:
      - KEYCLOAK_HOSTNAME=placeholder-initial-host.com
      - TMP_STRING=placeholder
resources:
  - namespaces.yaml
  - subscription.yaml
  - infrastructure.yaml
  - keycloak-instance.yaml
  - realm.yaml
replacements:
  # ------------------------------------------------------------------
  # REPLACEMENT 1: Inject Static Hostname into the Keycloak Route
  # ------------------------------------------------------------------
  - source:
      kind: ConfigMap
      name: tpa-values-source
      fieldPath: data.KEYCLOAK_HOSTNAME
    targets:
      - select:
          kind: Route
          name: keycloak
        fieldPaths:
          - spec.host
      - select:
          kind: Keycloak
          name: keycloak
        fieldPaths:
          - spec.hostname.hostname
  - source:
      kind: ConfigMap
      name: tpa-values-source
      fieldPath: data.TMP_STRING
    targets:
      - select:
          kind: KeycloakRealmImport
          name: keycloak-chicken
        fieldPaths:
          - spec.realm.users[0].credentials[0].value

