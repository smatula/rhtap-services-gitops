---
# ArgoCD Sync Hook - Generates secrets and ConfigMap during deployment
# Runs in sync-wave 1 (after RBAC resources in wave 0, before app resources in wave 2+)
apiVersion: batch/v1
kind: Job
metadata:
  name: tpa-generate-secrets
  namespace: tssc-tpa
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "1"
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: tpa-generate-secrets
    spec:
      restartPolicy: Never
      serviceAccountName: tpa-secret-generator
      containers:
        - name: generator
          image: image-registry.openshift-image-registry.svc:5000/openshift/tools:latest
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              echo "========================================"
              echo "TPA Secret Generator - Starting"
              echo "========================================"

              # Set namespace variables
              TPA_NAMESPACE="tssc-tpa"
              KEYCLOAK_NAMESPACE="tssc-keycloak"
              REALM="chicken"

              echo "Configuration:"
              echo "  TPA Namespace: $TPA_NAMESPACE"
              echo "  Keycloak Namespace: $KEYCLOAK_NAMESPACE"
              echo "  Realm: $REALM"
              echo ""

              # Get ingress domain
              echo "Querying cluster for ingress domain..."
              INGRESS_DOMAIN=$(oc -n openshift-ingress-operator get ingresscontrollers.operator.openshift.io default -o jsonpath='{.status.domain}')
              echo "  Ingress Domain: $INGRESS_DOMAIN"
              echo ""

              # Derive values
              APP_DOMAIN_URL="-${TPA_NAMESPACE}.${INGRESS_DOMAIN}"
              KEYCLOAK_HOST="sso.${INGRESS_DOMAIN}"
              OIDC_ISSUER_URL="https://sso.${INGRESS_DOMAIN}/realms/${REALM}"
              CYCLONEDX_VER="1.4"

              echo "Derived values:"
              echo "  APP_DOMAIN_URL: $APP_DOMAIN_URL"
              echo "  KEYCLOAK_HOST: $KEYCLOAK_HOST"
              echo "  OIDC_ISSUER_URL: $OIDC_ISSUER_URL"
              echo ""

              echo "Checking if secrets already exist..."

              # Check each resource individually for better debug output
              TPA_DB_EXISTS=false
              REALM_CLIENTS_EXISTS=false
              CONFIGMAP_EXISTS=false

              if oc get secret tpa-pgsql-user -n "$TPA_NAMESPACE" &>/dev/null; then
                echo "  ✓ Secret tpa-pgsql-user exists"
                TPA_DB_EXISTS=true
              else
                echo "  ✗ Secret tpa-pgsql-user does not exist"
              fi

              if oc get secret tpa-realm-chicken-clients -n "$TPA_NAMESPACE" &>/dev/null; then
                echo "  ✓ Secret tpa-realm-chicken-clients exists"
                REALM_CLIENTS_EXISTS=true
              else
                echo "  ✗ Secret tpa-realm-chicken-clients does not exist"
              fi

              if oc get configmap tpa-values-source -n "$TPA_NAMESPACE" &>/dev/null; then
                echo "  ✓ ConfigMap tpa-values-source exists"
                CONFIGMAP_EXISTS=true
              else
                echo "  ✗ ConfigMap tpa-values-source does not exist"
              fi

              echo ""

              # Exit early if all resources exist
              if [ "$TPA_DB_EXISTS" = true ] && [ "$REALM_CLIENTS_EXISTS" = true ] && [ "$CONFIGMAP_EXISTS" = true ]; then
                echo "All secrets and ConfigMap already exist - skipping generation"
                echo "========================================"
                exit 0
              fi

              echo "Some secrets or ConfigMap missing - proceeding with generation"
              echo "========================================"
              echo ""

              # Function to get existing secret or generate new
              get_or_generate_password() {
                local namespace=$1
                local name=$2
                local key=$3
                local length=${4:-16}

                existing=$(oc get secret "$name" -n "$namespace" -o jsonpath="{.data.$key}" 2>/dev/null | base64 -d || echo "")
                if [ -n "$existing" ]; then
                  echo "  Reusing existing password for $name/$key" >&2
                  echo "$existing"
                else
                  echo "  Generating new password for $name/$key" >&2
                  openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c "$length"
                fi
              }

              get_or_generate_uuid_password() {
                local namespace=$1
                local name=$2
                local key=$3

                existing=$(oc get secret "$name" -n "$namespace" -o jsonpath="{.data.$key}" 2>/dev/null | base64 -d || echo "")
                if [ -n "$existing" ]; then
                  echo "  Reusing existing password for $name/$key" >&2
                  echo "$existing"
                else
                  echo "  Generating new UUID-style password for $name/$key" >&2
                  random=$(openssl rand -base64 64 | tr -dc 'a-zA-Z0-9' | head -c 32)
                  echo "${random:0:8}-${random:8:4}-${random:12:4}-${random:16:4}-${random:20:12}"
                fi
              }

              # Generate or reuse passwords
              echo "Processing passwords..."
              TPA_USER_DB_PASS=$(get_or_generate_password "$TPA_NAMESPACE" "tpa-pgsql-user" "password" 16)
              KEYCLOAK_USER_DB_PASS=$(get_or_generate_password "$KEYCLOAK_NAMESPACE" "keycloak-pgsql-user" "password" 16)
              SEED_STRING=$(get_or_generate_password "$TPA_NAMESPACE" "tpa-realm-chicken-admin" "password" 16)
              PASS_CLI=$(get_or_generate_uuid_password "$TPA_NAMESPACE" "tpa-realm-chicken-clients" "cli")
              PASS_MANAGER=$(get_or_generate_uuid_password "$TPA_NAMESPACE" "tpa-realm-chicken-clients" "testingManager")
              PASS_USER=$(get_or_generate_uuid_password "$TPA_NAMESPACE" "tpa-realm-chicken-clients" "testingUser")
              echo ""

              # Create ConfigMap
              echo "Creating ConfigMap tpa-values-source..."
              echo ""
              echo "ConfigMap contents:"
              echo "  APP_DOMAIN_URL: $APP_DOMAIN_URL"
              echo "  OIDC_ISSUER_URL: $OIDC_ISSUER_URL"
              echo "  KEYCLOAK_HOSTNAME: $KEYCLOAK_HOST"
              echo "  REDIRECT_URI1: https://server$APP_DOMAIN_URL"
              echo "  REDIRECT_URI2: https://server$APP_DOMAIN_URL/*"
              echo "  REDIRECT_URI3: https://sbom$APP_DOMAIN_URL"
              echo "  REDIRECT_URI4: https://sbom$APP_DOMAIN_URL/*"
              echo ""
              set -x
              oc apply -f - <<EOF
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: tpa-values-source
                namespace: $TPA_NAMESPACE
                annotations:
                  argocd.argoproj.io/sync-options: Prune=false
              data:
                APP_DOMAIN_URL: "$APP_DOMAIN_URL"
                OIDC_ISSUER_URL: "$OIDC_ISSUER_URL"
                KEYCLOAK_HOSTNAME: "$KEYCLOAK_HOST"
                REDIRECT_URI1: "https://server$APP_DOMAIN_URL"
                REDIRECT_URI2: "https://server$APP_DOMAIN_URL/*"
                REDIRECT_URI3: "https://sbom$APP_DOMAIN_URL"
                REDIRECT_URI4: "https://sbom$APP_DOMAIN_URL/*"
              EOF
              set +x
              echo "✓ ConfigMap created/updated"
              echo ""

              # Create all secrets
              echo "Creating secrets..."
              oc apply -f - <<EOF
              ---
              apiVersion: v1
              kind: Secret
              type: Opaque
              metadata:
                name: tpa-pgsql-user
                namespace: $TPA_NAMESPACE
              stringData:
                dbname: tpa
                host: tpa-pgsql.tssc-tpa.svc
                user: tpa
                port: "5432"
                password: "$TPA_USER_DB_PASS"
              ---
              apiVersion: v1
              kind: Secret
              type: Opaque
              metadata:
                name: keycloak-pgsql-user
                namespace: $KEYCLOAK_NAMESPACE
              stringData:
                dbname: keycloak
                host: keycloak-pgsql.tssc-keycloak.svc
                user: keycloak
                port: "5432"
                password: "$KEYCLOAK_USER_DB_PASS"
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                annotations:
                  helm.sh/resource-policy: keep
                labels:
                  app: keycloak
                namespace: $TPA_NAMESPACE
                name: tpa-realm-chicken-admin
              type: Opaque
              stringData:
                username: admin
                password: "$SEED_STRING"
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                annotations:
                  helm.sh/resource-policy: keep
                labels:
                  app: keycloak
                namespace: $KEYCLOAK_NAMESPACE
                name: tpa-realm-chicken-admin
              type: Opaque
              stringData:
                username: admin
                password: $SEED_STRING
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                annotations:
                  helm.sh/resource-policy: keep
                labels:
                  app: keycloak
                namespace: $TPA_NAMESPACE
                name: tpa-realm-chicken-clients
              type: Opaque
              stringData:
                cli: "$PASS_CLI"
                testingManager: "$PASS_MANAGER"
                testingUser: "$PASS_USER"
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                annotations:
                  helm.sh/resource-policy: keep
                labels:
                  app: keycloak
                namespace: $KEYCLOAK_NAMESPACE
                name: tpa-realm-chicken-clients
              type: Opaque
              stringData:
                cli: $PASS_CLI
                testingManager: $PASS_MANAGER
                testingUser: $PASS_USER
              ---
              apiVersion: v1
              kind: Secret
              metadata:
                labels:
                  app: keycloak
                namespace: $TPA_NAMESPACE
                name: tssc-trustification-integration
                annotations:
                  helm.sh/resource-policy: keep
              type: Opaque
              stringData:
                bombastic_api_url: https://server$APP_DOMAIN_URL
                oidc_issuer_url: https://sso.$INGRESS_DOMAIN/realms/$REALM
                oidc_client_id: cli
                oidc_client_secret: $PASS_CLI
                supported_cyclonedx_version: "${CYCLONEDX_VER}"
              EOF
              echo "✓ All secrets created/updated"
              echo ""
              echo "========================================"
              echo "Secret generation completed successfully!"
              echo "========================================"
              echo ""
              echo "Summary:"
              echo "  - 7 Secrets created"
              echo "  - 1 ConfigMap created"
              echo "  - Cluster domain: $INGRESS_DOMAIN"
